<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.kimkeyring.mapper.OrderMapper">

    <!-- orders 테이블에 주문 저장 -->
    <insert id="insertOrder"
                 parameterType="com.kimkeyring.entity.Order"
                 useGeneratedKeys="true"
                 keyProperty="orderId"
                 keyColumn="order_id">
        INSERT INTO orders (
            user_id,
            total_price,
            status,
            address,
            address_detail,
            created_at
        ) VALUES (
            #{userId},
            #{totalPrice},
            #{status},
            #{address},
            #{addressDetail},
            NOW()
        )
    </insert>

    <!-- order_items 테이블에 주문 상품 저장 -->
    <insert id="insertOrderItem"
                 parameterType="com.kimkeyring.entity.OrderItem">
        INSERT INTO order_items (
            order_id,
            product_id,
            quantity,
            price
        ) VALUES (
            #{orderId},
            #{productId},
            #{quantity},
            #{price}
        )
    </insert>

    <!-- 특정 사용자의 모든 주문 조회 (최신순) -->
    <select id="findByUserId" resultType="com.kimkeyring.entity.Order">
        SELECT
            order_id AS orderId,
            user_id AS userId,
            total_price AS totalPrice,
            status,
            address,
            address_detail AS addressDetail,
            created_at AS createdAt
        FROM orders
        WHERE user_id = #{userId}
        ORDER BY created_at DESC
    </select>

    <!-- 주문 ID로 주문 상세 조회 -->
    <select id="findById" resultType="com.kimkeyring.entity.Order">
        SELECT
            order_id AS orderId,
            user_id AS userId,
            total_price AS totalPrice,
            status,
            address,
            address_detail AS addressDetail,
            created_at AS createdAt
        FROM orders
        WHERE order_id = #{orderId}
    </select>

    <!-- 특정 주문의 주문 상품 목록 조회 -->
    <select id="findItemsByOrderId" resultType="com.kimkeyring.entity.OrderItem">
        SELECT
            order_item_id AS orderItemId,
            order_id AS orderId,
            product_id AS productId,
            quantity,
            price
        FROM order_items
        WHERE order_id = #{orderId}
    </select>


    <!-- ResultMap: OrderHistoryDTO 매핑 -->
    <resultMap id="OrderHistoryMap" type="com.kimkeyring.dto.OrderHistoryDTO">
        <!-- Order 정보 -->
        <id property="orderId" column="order_id"/>
        <result property="userId" column="user_id"/>
        <result property="totalPrice" column="total_price"/>
        <result property="status" column="status"/>
        <result property="address" column="address"/>
        <result property="addressDetail" column="address_detail"/>
        <result property="createdAt" column="created_at"/>

        <!-- OrderItem 리스트 (collection!) -->
        <collection property="items" ofType="com.kimkeyring.dto.OrderItemDTO">
            <id property="orderItemId" column="order_item_id"/>
            <result property="orderId" column="order_id"/>
            <result property="productId" column="product_id"/>
            <result property="quantity" column="quantity"/>
            <result property="price" column="item_price"/>
            <result property="productName" column="product_name"/>
            <result property="productImageUrl" column="product_image_url"/>
        </collection>
    </resultMap>

    <!-- 사용자의 주문 목록 + 상품 정보 (JOIN) -->
    <select id="findOrderHistoryByUserId" resultMap="OrderHistoryMap">
        SELECT
            o.order_id,
            o.user_id,
            o.total_price,
            o.status,
            o.address,
            o.address_detail,
            o.created_at,
            oi.order_item_id,
            oi.product_id,
            oi.quantity,
            oi.price AS item_price,
            p.name AS product_name,
            p.emoji AS product_image_url
        FROM orders o
        LEFT JOIN order_items oi ON o.order_id = oi.order_id
        LEFT JOIN products p ON oi.product_id = p.product_id
        WHERE o.user_id = #{userId}
        ORDER BY o.created_at DESC
    </select>

</mapper>